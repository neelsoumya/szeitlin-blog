<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title> </title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.32.2" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    <link href='http://example.org/dist/main.css' rel='stylesheet' type="text/css" />
    
      
    

    

    <meta property="og:title" content="" />
<meta property="og:description" content="For better or worse, when you&rsquo;re dealing with data pipelines of varying shapes and sizes, sometimes you need to combine objects that don&rsquo;t match up evenly.
For example, if you want to apply a condition via lookup, sometimes it makes sense to just do a merge. This creates a new column in your data table, and then you can use that for reference.
This is an extremely simple example to show what I mean:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/data-pipelining-with-pandas-automating-lookup-and-update/" />
















<meta itemprop="name" content="">
<meta itemprop="description" content="For better or worse, when you&rsquo;re dealing with data pipelines of varying shapes and sizes, sometimes you need to combine objects that don&rsquo;t match up evenly.
For example, if you want to apply a condition via lookup, sometimes it makes sense to just do a merge. This creates a new column in your data table, and then you can use that for reference.
This is an extremely simple example to show what I mean:">



<meta itemprop="wordCount" content="652">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content=""/>
<meta name="twitter:description" content="For better or worse, when you&rsquo;re dealing with data pipelines of varying shapes and sizes, sometimes you need to combine objects that don&rsquo;t match up evenly.
For example, if you want to apply a condition via lookup, sometimes it makes sense to just do a merge. This creates a new column in your data table, and then you can use that for reference.
This is an extremely simple example to show what I mean:"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="http://example.org/" class="f3 fw2 hover-white no-underline white-90 dib">
      
    </a>
    <div class="flex-l items-center">
      
      








    </div>
  </div>
</nav>

    </div>
  </header>


    <main class="pb7" role="main">
      
  <div class="flex-l mt2 mw8 center">
    <article class="center cf pv5 ph3 ph4-ns mw7">
      <header>
        <p class="f6 b helvetica tracked">
          POSTS
        </p>
        <h1 class="f1">
          
        </h1>
      </header>
      <div class="nested-copy-line-height lh-copy f4 nested-links nested-img mid-gray">
        <p>For better or worse, when you&rsquo;re dealing with data pipelines of varying shapes and sizes, sometimes you need to combine objects that don&rsquo;t match up evenly.</p>

<p>For example, if you want to apply a condition via lookup, sometimes it makes sense to just do a merge. This creates a new column in your data table, and then you can use that for reference.</p>

<p>This is an extremely simple example to show what I mean:</p>

<p>[code lang=&ldquo;python&rdquo;]
    import pandas</p>

<pre><code>table = pandas.DataFrame({'Existing Column':['apples', 'oranges']})
</code></pre>

<p>[/code]</p>

<p><img src="/site_media/media/580ab176b1cd1.png" alt="Screen Shot 2016-01-02 at 7.51.21 PM.png" /></p>

<pre><code>reference_table = pandas.DataFrame({'Reference Column':['apples', 'lemons']})
</code></pre>

<p><img src="/site_media/media/777ea54eb1cd1.png" alt="Screen Shot 2016-01-02 at 7.52.29 PM.png" /></p>

<pre><code>merge = pandas.concat([table,reference_table], axis=1)
</code></pre>

<p><img src="/site_media/media/9c799854b1cd1.png" alt="Screen Shot 2016-01-02 at 7.53.22 PM.png" /></p>

<pre><code>merge['Result Column'] = merge['Existing Column'] == merge['Reference Column']
</code></pre>

<p><img src="/site_media/media/bf4f535ab1cd1.png" alt="Screen Shot 2016-01-02 at 7.54.37 PM.png" /></p>

<hr />

<p>That works fine, especially if you don&rsquo;t need to do a complicated merge.</p>

<p>However, if your problem meets the following criteria, you might be stuck looking for a better solution:</p>

<ul>
<li>If you have a list of several conditions, each of which is only expected to apply to a small subset of rows in your table</li>
<li>If the list of conditions may vary in length, and you don&rsquo;t know in advance how long it will be</li>
<li>If you don&rsquo;t want to deal with NaNs, which tends to be a problem if your reference table is much smaller than your target table</li>
<li>If you don&rsquo;t want to worry about dropping column names each time you go through the loop, which tends to be a problem if you have any duplicate column names being created during the merge (and if any of the dropping fails, you end up with &lsquo;col_x_x&rsquo; and &lsquo;col_x_y&rsquo;, etc. And that&rsquo;s, ugh, in my opinion, best avoided)</li>
<li>Your data set isn&rsquo;t too huge</li>
<li>You don&rsquo;t mind if the process isn&rsquo;t the fastest, because accuracy matters more for your purposes</li>
</ul>

<p>Then you might want to try this solution.</p>

<hr />

<p>The general structure looks like this:</p>

<p><strong>Step 1. Create list of masks</strong></p>

<p>Iterate through your reference material to create masks. The mask is how you apply the conditional logic to a whole dataframe at once. It&rsquo;s sort of like a filter.</p>

<p><strong>Step 2. Apply masks</strong></p>

<p>Iterate through the masks, applying each one to your target dataframe. Keep in mind that if your masks are not unique in all aspects, unless you build in extra checks, you might risk overwriting some values, if there are any overlaps. This approach worked for my purposes because I knew that all the masks were unique by definition.</p>

<p>I also recommend that you write and run tests for these methods, to make sure the masks match what you expect, and that all the masks were applied as expected. You also might want to test to make sure there are no NaNs at the end, if you care about that sort of thing, in case your masks don&rsquo;t fill all the rows in all the columns.</p>

<p>[code lang=&ldquo;python&rdquo;]</p>

<pre><code>def create_masks(reference_df, target_df):
    &quot;&quot;&quot;&quot; Apply conditional logic to create masks and append them to a list for use later &quot;&quot;&quot;

    listofmasks = []

    for x in reference_df.index:
         #simple example, you can chain other set logic here as needed

         mask = (target_df['ref_col'] == reference_df.loc[x, 'ref_col']) 
         listofmasks.append(x, mask)

    return listofmasks
</code></pre>

<p>def apply_masks(reference_df, target_df, listofmasks):
       &ldquo;&rdquo;&rdquo; Use conditional logic to update target dataframe &ldquo;&rdquo;&rdquo;</p>

<pre><code>   for x, mask in listofmasks:

     #make sure something matches your criteria 
     if target_df[mask].shape[0] &gt; 0:    


        second_mask = (target_df['ref_col2'] &gt; reference_df.loc[x, 'ref_col3']):  

        both_masks = mask &amp; second_mask

        result = reference_df.loc[x, ‘result_col’]

        # finally, update the appropriate rows in the dataframe 
        #np.where (here, if this, else fill) is fine if you're not iterating

        #If iterating, use masks again, otherwise you risk overwriting 
        target_df.loc[both_masks,'target_col']= result

    return target_df
</code></pre>

<p>[/code]</p>

<p>Obviously, you might not want to always update the same column, so I actually combined this with dynamic naming. To do that, I created and added a name to each tuple that contains the masks. That way, the name also gets passed into the method, so it&rsquo;s available when the mask is applied, so I can create new columns or update existing ones as appropriate.</p>

      </div>
    </article>
    <aside class="ph3 mt2 mt6-ns">
      







  <div class="bg-light-gray pa3">
    <ul>
      <li class="list b mb3">
        29 More Posts
      </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/airflow-for-hands-off-etl/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/automating-user-friendly-documentation-using-selenium-/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/bike-data-from-xml-to-plots/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/biking-data-from-xml-to-plots-part-2/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/biking-data-from-xml-to-plots-part-3/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/biking-data-from-xml-to-plots-part-4/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/biking-data-from-xml-to-plots-revised/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/converting-a-python-script-to-a-spark-pipeline/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/data-pipelining-with-pandas-automating-lookup-and-update/" class="link ph2 pv2 db black o-50">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/faq-why-and-how-i-learned-to-code/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/fun-with-failing/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/game-plan-for-conferences-with-high-risk-of-harassment/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/importing-csv-data-into-neo4j/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/more-biking-data/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/probability-binning-part-2-speeding-up-machine-learning/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/probability-binning-simple-and-fast/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/python-where-to-start/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/quick-and-dirty-plot-your-data-on-a-map/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/recursion-excursion/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/robustness-lessons-from-doing-applied-bench-science/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/shuffling-the-deck-an-interview-question/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/still-looking-for-a-job-advice-on-recruiting-/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/test-driven-data-pipelining/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/things-i-learned-about-pyspark-the-hard-way/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/things-i-learned-about-zip-files-last-week/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/things-i-learned-studying-the-cell-cycle-in-cancer/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/tips-on-giving-presentations/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/transitioning-to-data-science/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/validating-results/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/within-every-tutorial-is-another-tutorial/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
    </ul>
  </div>


    </aside>
  </div>

    </main>
    <footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://example.org/" >
    &copy; 2018 
  </a>
  








  </div>
</footer>

    <script src="http://example.org/dist/app.bundle.js" async></script>

  </body>
</html>
