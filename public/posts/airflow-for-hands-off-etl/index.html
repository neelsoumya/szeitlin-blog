<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>My New Hugo Site </title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.32.2" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    <link href='http://example.org/dist/main.css' rel='stylesheet' type="text/css" />
    
      
    

    

    <meta property="og:title" content="" />
<meta property="og:description" content="Almost exactly a year ago, I joined Yahoo, which more recently became Oath.
The team I joined is called the Product Hackers, and we work with large amounts of data. By large amounts I meant, billions of rows of log data.
Our team does both ad-hoc analyses and ongoing machine learning projects. In order to support those efforts, our team had initially written scripts to parse logs and run them with cron to load the data into Redshift on AWS." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/airflow-for-hands-off-etl/" />
















<meta itemprop="name" content="">
<meta itemprop="description" content="Almost exactly a year ago, I joined Yahoo, which more recently became Oath.
The team I joined is called the Product Hackers, and we work with large amounts of data. By large amounts I meant, billions of rows of log data.
Our team does both ad-hoc analyses and ongoing machine learning projects. In order to support those efforts, our team had initially written scripts to parse logs and run them with cron to load the data into Redshift on AWS.">



<meta itemprop="wordCount" content="1008">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content=""/>
<meta name="twitter:description" content="Almost exactly a year ago, I joined Yahoo, which more recently became Oath.
The team I joined is called the Product Hackers, and we work with large amounts of data. By large amounts I meant, billions of rows of log data.
Our team does both ad-hoc analyses and ongoing machine learning projects. In order to support those efforts, our team had initially written scripts to parse logs and run them with cron to load the data into Redshift on AWS."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="http://example.org/" class="f3 fw2 hover-white no-underline white-90 dib">
      My New Hugo Site
    </a>
    <div class="flex-l items-center">
      
      








    </div>
  </div>
</nav>

    </div>
  </header>


    <main class="pb7" role="main">
      
  <div class="flex-l mt2 mw8 center">
    <article class="center cf pv5 ph3 ph4-ns mw7">
      <header>
        <p class="f6 b helvetica tracked">
          POSTS
        </p>
        <h1 class="f1">
          
        </h1>
      </header>
      <div class="nested-copy-line-height lh-copy f4 nested-links nested-img mid-gray">
        

<p>Almost exactly a year ago, I joined <a href="https://www.yahoo.com">Yahoo</a>, which more recently became <a href="https://www.oath.com">Oath</a>.</p>

<p>The team I joined is called the Product Hackers, and we work with large amounts of data. By large amounts I meant, billions of rows of log data.</p>

<p>Our team does both ad-hoc analyses and ongoing machine learning projects. In order to support those efforts, our team had initially written scripts to parse logs and run them with cron to load the data into Redshift on AWS. After a while, it made sense to move to <a href="http://pythonhosted.org/airflow/">Airflow</a>.</p>

<hr />

<h2 id="do-you-need-airflow">Do you need Airflow?</h2>

<ol>
<li>How much data do you have?    <em>A lot</em></li>
<li>Do you use cron jobs for ETL? How many?     <em>Too many</em></li>
<li>Do you have to re-run scripts manually when they fail? How often?      <em>Yes, often enough to be a pain point</em></li>
<li>Do you use on-call shifts to help maintain infrastructure?      <em>Unfortunately, we did</em></li>
</ol>

<hr />

<h2 id="what-exactly-is-airflow">What exactly is Airflow?</h2>

<p>Airflow is an open-source python library. It creates Directed Acyclic Graphs (DAGs) for extracting, transforming, and loading data.</p>

<p>&lsquo;Directed&rsquo; just means the tasks are supposed to be executed in order (although this is not actually required, tasks don&rsquo;t even have to be connected to each other and they&rsquo;ll still run). &lsquo;Acyclic&rsquo; means tasks are not connected in a circle (although you can write loops that generate tasks dynamically, you still don&rsquo;t want circular dependencies).</p>

<p>A DAG in this case is a python object made up of tasks. A typical DAG might contain tasks that do the kinds of things you might do with cron jobs:</p>

<p>get logs &ndash;&gt; parse logs &ndash;&gt; create table in database &ndash;&gt; load log data into new table</p>

<p>Each DAG step is executed by an Operator (also a python object).</p>

<p>Operators use Hooks to connect to external resources (like AWS services).</p>

<p>Task instances refer to attempts to run specific tasks, so they have state that you can view in the dashboard. The state tells you whether that tasks is currently executing, succeeded, failed, skipped, or waiting in the queue.</p>

<hr />

<h2 id="some-tips-if-you-re-going-to-use-airflow">Some tips if you&rsquo;re going to use Airflow</h2>

<ul>
<li>### Make your jobs idempotent if possible ###</li>
</ul>

<p>My team has a couple different types of tables that we load into Redshift. One is the type we call &lsquo;metadata&rsquo;, which is typically just a simple mapping that doesn&rsquo;t change very often. For this type of table, when it does change, it&rsquo;s important to drop the old table and re-create it from scratch. This is easier to manage with separate tasks for each SQL step, so the DAG has the following steps:</p>

<p>get_data &ndash;&gt; drop_old_table &ndash;&gt; create_new_table &ndash;&gt; load_data</p>

<p>This way, if any of the steps fail, we can re-start from there, and it doesn&rsquo;t matter if the step was partially completed before it failed.</p>

<p>The other kind of table we have is an event table, and those are loaded with fresh data every day. We retain the data for 3 days before we start running out of space on the Redshift cluster. This kind of table doesn&rsquo;t really need a drop_old_table step, because the table name includes the date (which makes it easier to find the table you want when you&rsquo;re running queries). However, when we create these tables, we still want to make sure we don&rsquo;t create duplicates, so in the create step we check to see if the table already exists.</p>

<ul>
<li>### Get AIRFLOW_HOME depending on where you&rsquo;re running ###</li>
</ul>

<p>If you want a really stable build that requires the least amount of hands-on maintenance, do yourself a favor and &lsquo;productionize&rsquo; your setup. That means you&rsquo;ll want to run Airflow in at least 3 places:</p>

<ol>
<li>In a virtual environment on your local machine (we use Docker with Ansible)</li>
<li>In a virtual environment in your continuous integration system (we use Jenkins)</li>
<li>In a virtual environment on your production host (we use virtualenv with python 3)</li>
</ol>

<p>Note that Airflow doesn&rsquo;t make this easy, so I wrote a little helper script to make sure Airflow has the right configuration files and is able to find the DAGs, both of which are dependent on using the correct AIRFLOW_HOME environment variable.</p>

<p>Here&rsquo;s the TL;DR:</p>

<p>[code lang=&ldquo;python&rdquo;]
    #If AIRFLOW_HOME environment variable doesn’t exist, it defaults:
        os.getenv(&lsquo;AIRFLOW_HOME&rsquo;, &lsquo;~/airflow&rsquo;)</p>

<pre><code>#It’s really useful to always check where the code is running:
    homedir = os.getenv('HOME')

#If it’s on Jenkins, there’s an environment variable that gives you the path for that:
    jenkins_path = os.getenv('JENKINS_HOME', None)

#In the Jenkinsfile (without Docker), we’re doing this: 
    withEnv(['AIRFLOW_HOME=/br/airflow'])
    cp -r $PWD/dags $AIRFLOW_HOME/

#If you’re running tests locally, there’s a helper that I stole from inside Airflow’s guts:
    import airflow.configuration as conf
    conf.load_test_config()
    os.environ['TEST_CONFIG_FILE'] = conf.TEST_CONFIG_FILE
</code></pre>

<p>[/code]</p>

<ul>
<li>### Write unit tests for your Operators and your DAGs ###</li>
</ul>

<p>I hadn&rsquo;t seen anyone doing this for Airflow, but I write tests for all my python code, so why should Airflow be any different?</p>

<p>It&rsquo;s a little unintuitive, because Airflow DAG files are not like regular python files. DAG objects have to be at the top level, so the way I got around this was to grab the dag file and then get each of the task objects as attributes.</p>

<p>I wrote the tests for the Operators so that they could be easily re-used, since most of our DAGs have similar tasks. This also lets us use unit tests to enforce best practices.</p>

<p>[code lang=&ldquo;python&rdquo;]
class TestPostgresOperators:
    &ldquo;&rdquo;&rdquo;
    Not meant to be used alone
    For use within specific dag test file
    &ldquo;&rdquo;&rdquo;
    @classmethod
    def setUp(cls, dagfile):
        cls.dagfile = dagfile</p>

<pre><code>def test_droptable(self, taskname='dropTable'):
    '''
    validate fields here
    check retries number
    :param taskname: str

    '''
   drop = getattr(self.dagfile, taskname)
   assert(0 &lt;= drop.retries &lt;= 5)
   assert(drop.postgres_conn_id=='redshift')
</code></pre>

<p>[/code]</p>

<p>Then these &lsquo;abstract tests&rsquo; get instantiated in the test file for a particular DAG, like this:</p>

<p>[code lang=&ldquo;python&rdquo;]
import advertisers_v2
from test_dag_instantiation import TestDAGInstantiation
from conftest import unittest_config</p>

<p>from test_postgres_operators import TestPostgresOperators
from test_mysql_to_redshift import TestMySQLtoRedshiftOperator</p>

<p>mydag = TestDAGInstantiation()
mydag.setUp(advertisers_v2,unittest_config=unittest_config)
mydag.test_dagname()
mydag.test_default_args()</p>

<p>postgres_tests = TestPostgresOperators()
postgres_tests.setUp(advertisers_v2)
postgres_tests.test_droptable()
postgres_tests.test_createtable()</p>

<p>mysql_to_redshift_tests = TestMySQLtoRedshiftOperator()
mysql_to_redshift_tests.setUp(advertisers_v2)
mysql_to_redshift_tests.test_importstep()
[/code]</p>

<p>Doing it this way makes it ridiculously easy to set up tests, and they can still be parameterized however you want, to test customizations as needed.</p>

      </div>
    </article>
    <aside class="ph3 mt2 mt6-ns">
      







  <div class="bg-light-gray pa3">
    <ul>
      <li class="list b mb3">
        29 More Posts
      </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/airflow-for-hands-off-etl/" class="link ph2 pv2 db black o-50">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/automating-user-friendly-documentation-using-selenium-/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/bike-data-from-xml-to-plots/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/biking-data-from-xml-to-plots-part-2/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/biking-data-from-xml-to-plots-part-3/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/biking-data-from-xml-to-plots-part-4/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/biking-data-from-xml-to-plots-revised/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/converting-a-python-script-to-a-spark-pipeline/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/data-pipelining-with-pandas-automating-lookup-and-update/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/faq-why-and-how-i-learned-to-code/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/fun-with-failing/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/game-plan-for-conferences-with-high-risk-of-harassment/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/importing-csv-data-into-neo4j/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/more-biking-data/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/probability-binning-part-2-speeding-up-machine-learning/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/probability-binning-simple-and-fast/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/python-where-to-start/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/quick-and-dirty-plot-your-data-on-a-map/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/recursion-excursion/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/robustness-lessons-from-doing-applied-bench-science/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/shuffling-the-deck-an-interview-question/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/still-looking-for-a-job-advice-on-recruiting-/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/test-driven-data-pipelining/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/things-i-learned-about-pyspark-the-hard-way/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/things-i-learned-about-zip-files-last-week/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/things-i-learned-studying-the-cell-cycle-in-cancer/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/tips-on-giving-presentations/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/transitioning-to-data-science/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/validating-results/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
        <li class="list f5 w-100 hover-bg-white nl1">
          
          <a href="/posts/within-every-tutorial-is-another-tutorial/" class="link ph2 pv2 db black">
            
          </a>
        </li>
      
    </ul>
  </div>


    </aside>
  </div>

    </main>
    <footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://example.org/" >
    &copy; 2018 My New Hugo Site
  </a>
  








  </div>
</footer>

    <script src="http://example.org/dist/app.bundle.js" async></script>

  </body>
</html>
